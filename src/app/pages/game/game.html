<div
  class="game-container"
  *ngIf="state$ | async as state"
  [class.host-view]="state.hostId === socket.playerId"
  [class.player-view]="state.hostId !== socket.playerId"
>
  <!-- GLOBAL SOUND EFFECTS -->
  <audio #correctSound src="assets/sounds/correct-answer.mp3"></audio>
  <audio #wrongSound src="assets/sounds/wrong-answer.mp3"></audio>
  <audio #winSound src="assets/sounds/win.mp3"></audio>

  <!-- HEADER -->
  <header class="game-header">
    <h1>ğŸ® Team Quiz Night</h1>

    <div class="player-info" *ngIf="state.phase !== 'ENDED'">
      ğŸ‘¤ {{ getCurrentPlayer(state)?.name }}
      <span class="team">({{ getCurrentPlayer(state)?.team }})</span>
    </div>

    <div *ngIf="state.hostId === socket.playerId && state.phase !== 'ENDED'" class="share-box">
      <span>{{ origin }}/join/{{ socket.sessionId }}</span>
      <button (click)="copyLink()">ğŸ“‹ Copy Invite</button>
    </div>
  </header>

  <!-- NORMAL GAME FLOW -->
  <ng-container *ngIf="state.phase !== 'ENDED'; else leaderboardView">
    <div class="round-info" *ngIf="state.roundName">â­ Round: {{ state.roundName }}</div>

    <section class="question-area">
      <div class="question-card" *ngIf="state.question; else waiting">
        {{ state.question }}
      </div>

      <ng-template #waiting>
        <div class="rules-card" *ngIf="state.phase === 'WAITING'; else nextQ">
          <h3>ğŸ® Game Rules</h3>
          <ul>
            <li>Wait for the host to start the question.</li>
            <li>When question appears, buzz fast!</li>
            <li>Only first buzzer gets chance to answer.</li>
            <li>Correct answer earns 1 point.</li>
            <li>Highest individual score wins a reward ğŸ</li>
          </ul>
        </div>

        <ng-template #nextQ>
          <div class="question-card waiting">â³ Waiting for next questionâ€¦</div>
        </ng-template>
      </ng-template>
    </section>

    <section class="action-area">
      <button
        class="buzz-btn"
        [disabled]="state.phase !== 'QUESTION_LIVE' || !state.buzzerEnabled"
        (click)="buzz()"
      >
        ğŸ”´ BUZZ NOW
      </button>

      <div class="winner-banner" *ngIf="getWinner(state) as winner">
        âš¡ {{ winner.name }} ({{ winner.team }}) buzzed first!
      </div>
    </section>

    <section class="scores-area">
      <h3>ğŸ† Team Scores</h3>
      <div class="scores-grid">
        <div class="team-score" *ngFor="let team of getTeamScores(state.players) | keyvalue">
          <div class="team-name">{{ team.key }}</div>
          <div class="team-points">{{ team.value }}</div>
        </div>
      </div>
    </section>

    <section *ngIf="state.hostId === socket.playerId" class="host-panel">
      <h3>ğŸ‘‘ Host Controls</h3>

      <button *ngIf="state.phase === 'WAITING'" (click)="nextQuestion()">
        â–¶ï¸ Start Next Question
      </button>

      <button *ngIf="state.phase === 'QUESTION_DISPLAYED'" (click)="enableBuzzers()">
        ğŸ”” Enable Buzzers
      </button>

      <div *ngIf="state.currentBuzzPlayerId" class="answer-controls">
        <button class="correct" (click)="markCorrect(); correctSound.play()">âœ… Correct</button>
        <button class="wrong" (click)="markWrong(); wrongSound.play()">âŒ Wrong</button>
      </div>

      <button class="end-btn" (click)="endGame()">ğŸ End Game</button>
    </section>
  </ng-container>

  <!-- FINAL LEADERBOARD -->
  <ng-template #leaderboardView>
    <div class="celebration-banner">ğŸ‰ Congratulations Winners! ğŸ‰</div>

    <section class="leaderboard" (mouseenter)="winSound.play()">
      <h1 class="leaderboard-title">ğŸ GAME OVER</h1>
      <h2 class="leaderboard-subtitle">ğŸ† Final Results</h2>

      <div class="leaderboard-grid">
        <div
          class="leaderboard-card"
          *ngFor="let p of state.players"
          [class.champion]="p.score === state.topScore"
        >
          <div class="player-name">{{ p.name }}</div>
          <div class="player-team">{{ p.team }}</div>
          <div class="player-score">{{ p.score }}</div>
        </div>
      </div>

      <!-- INDIVIDUAL WINNER QR -->
      <div class="winner-reward" *ngIf="state.individualWinner as winner">
        <h2 class="winner-name">ğŸ‰ Champion: {{ winner.name }}</h2>

        <div class="qr-box">
          <img src="assets/reward-qr.png" alt="Reward QR" />
        </div>

        <p class="reward-msg">Scan to claim your reward ğŸ</p>
      </div>
    </section>
  </ng-template>
</div>
