<div
  class="game-container"
  *ngIf="state$ | async as state"
  [class.host-view]="state.hostId === socket.playerId"
  [class.player-view]="state.hostId !== socket.playerId"
>
  <audio id="correctSound" src="assets/sounds/correct-answer.mp3"></audio>
  <audio id="wrongSound" src="assets/sounds/wrong-answer.mp3"></audio>
  <audio id="winnerSound" src="assets/sounds/win.mp3"></audio>
  <audio id="buzzSound" src="assets/sounds/buzz.mp3"></audio>
  <!-- HEADER -->
  <header class="game-header">
    <h1>ğŸ® NaaS Team Quiz</h1>

    <div class="player-info" *ngIf="state.phase !== 'ENDED'">
      ğŸ‘‘ <span *ngIf="socket.playerId === state.hostId">Host</span>
      {{ getCurrentPlayer(state)?.name }}
      <span class="team-badge" [ngClass]="getCurrentPlayer(state)?.team">
        {{ getCurrentPlayer(state)?.team }}
      </span>
    </div>

    <div *ngIf="state.hostId === socket.playerId && state.phase !== 'ENDED'" class="share-box">
      <span>{{ origin }}/join/{{ socket.sessionId }}</span>
      <button (click)="copyLink()">ğŸ“‹ Copy Invite</button>
    </div>
  </header>

  <!-- ================= NORMAL GAME ================= -->
  <ng-container *ngIf="state.phase !== 'ENDED'; else leaderboardView">
    <div class="round-info" *ngIf="state.roundName">â­ Round: {{ state.roundName }}</div>

    <!-- QUESTION -->
    <section class="question-area">
      <div class="question-card" *ngIf="state.question; else waiting">
        <h2>{{ state.question }}</h2>

        <img
          *ngIf="state.questionType === 'image'"
          [src]="'assets/' + state.mediaUrl"
          class="quiz-media"
        />

        <audio *ngIf="state.questionType === 'audio'" controls autoplay class="quiz-media">
          <source [src]="'assets/' + state.mediaUrl" />
        </audio>
      </div>
      <div *ngIf="state.answer" class="answer-reveal">âœ… Correct Answer: {{ state.answer }}</div>

      <ng-template #waiting>
        <div class="rules-card" *ngIf="state.phase === 'WAITING'; else nextQ">
          <h3>ğŸ® Game Rules</h3>
          <ul>
            <li>âš¡ Wait for host to start the question</li>
            <li>ğŸ”´ Buzz fast when question appears</li>
            <li>ğŸ¥‡ First buzzer answers</li>
            <li>âœ… Correct answer earns 1 point</li>
            <li>ğŸ Highest scorer wins reward</li>
          </ul>
        </div>

        <ng-template #nextQ>
          <div class="question-card waiting">â³ Waiting for next questionâ€¦</div>
        </ng-template>
      </ng-template>
    </section>

    <!-- BUZZER -->
    <section class="action-area">
      <button
        class="buzz-btn"
        [disabled]="state.phase !== 'QUESTION_LIVE' || !state.buzzerEnabled"
        (click)="buzz()"
      >
        ğŸ”´ BUZZ NOW
      </button>

      <section *ngIf="state.hostId === socket.playerId" class="host-panel">
        <h3>ğŸ‘‘ Host Controls</h3>

        <!-- Start game -->
        <button *ngIf="state.phase === 'WAITING'" (click)="nextQuestion()">
          â–¶ï¸ Start Game / Next Question
        </button>
        <button
          *ngIf="state.phase !== 'WAITING' && state.phase !== 'ENDED'"
          (click)="skipQuestion()"
        >
          â­ Skip Question
        </button>

        <!-- Correct/Wrong -->
        <div *ngIf="state.currentBuzzPlayerId">
          <button class="correct" (click)="markCorrect()">âœ… Correct</button>
          <button class="wrong" (click)="markWrong()">âŒ Wrong</button>
        </div>

        <button class="end-btn" (click)="endGame()">ğŸ End Game</button>
      </section>

      <div class="winner-banner" *ngIf="getWinner(state) as winner">
        âš¡ {{ winner.name }}
        <span class="team-badge" [ngClass]="winner.team">{{ winner.team }}</span>
        buzzed first!
      </div>
    </section>

    <!-- TEAM SCORE PROGRESS -->
    <section class="scores-area">
      <h3>ğŸ† Team Scores</h3>
      <div class="team-progress" *ngFor="let team of getTeamScores(state.players) | keyvalue">
        <span>{{ team.key }}</span>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="team.value * 10"></div>
        </div>
        <span>{{ team.value }}</span>
      </div>
    </section>

    <!-- PLAYERS PANEL WITH JOIN ANIMATION -->
    <aside class="players-panel" *ngIf="state.players?.length">
      <h4>ğŸ‘¥ Players</h4>
      <div class="players-list">
        <div class="player-chip fade-in" *ngFor="let p of state.players">
          <span class="player-name">
            {{ p.name }} <span *ngIf="p.id === state.hostId">ğŸ‘‘</span>
          </span>
          <span class="team-badge" [ngClass]="p.team">{{ p.team }}</span>
        </div>
      </div>
    </aside>
  </ng-container>

  <!-- ================= LEADERBOARD ================= -->
  <ng-template #leaderboardView>
    <section class="leaderboard fireworks-bg">
      <h1>ğŸ GAME OVER</h1>
      <h2>ğŸ† Final Results</h2>

      <div class="leaderboard-grid">
        <div
          class="leaderboard-card"
          *ngFor="let p of state.players | orderByScore | slice: 0 : 3; let i = index"
          [class.champion]="i === 0"
        >
          <div class="medal">
            {{ i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰' }}
          </div>

          <div class="player-name">{{ p.name }} <span *ngIf="p.id === state.hostId">ğŸ‘‘</span></div>

          <div class="team-badge" [ngClass]="p.team">{{ p.team }}</div>

          <div class="player-score">{{ p.score }}</div>
        </div>
      </div>

      <div class="winner-reward" *ngIf="state.phase === 'ENDED' && state.individualWinner">
        <h2 class="winner-title">ğŸ† Champion: {{ state.individualWinner.name }}</h2>

        <img src="assets/reward.png" class="reward-qr" />

        <p class="reward-text">Scan to claim your reward ğŸ</p>
      </div>
    </section>
  </ng-template>
</div>
